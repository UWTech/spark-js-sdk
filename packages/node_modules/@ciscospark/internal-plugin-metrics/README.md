# @ciscospark/internal-plugin-metrics

Plugin responsible for sending metrics for purposes of tracking usage patterns and gauging performance of Spark client application.

## Table of Contents

- [Usage](#usage)
- [API](#api)
- [Maintainers](#maintainers)
- [Contribute](#contribute)
- [License](#license)

## Usage

To use the SDK, you will need Cisco Spark credentials. If you do not already have a Cisco Spark account, visit
[Spark for Developers](https://developer.ciscospark.com/) to create your account and retrieve your access token.

See [the detailed docs](https://ciscospark.github.io/spark-js-sdk/) for more usage examples.

The metrics module in the default case will send well formed metrics via submitClientMetrics via a batch process.

The metrics module also has a concpet of an "internal" and "external/client" metric. An "internal" metric is one that is exclusively managed by the
SDK itself, whereas an "external/client" metric is a metric that originates and is managed by via client-side calls to the metrics module. An external metric can be updated via the SDK, but may not be sent by the SDK. Conversely, an external, or client-side actor cannot send an SDK (internal) metric, but may update the metric's data. 

The purpose of internal and external metrics is to allow the sharing of context information which may be present in the SDK context, but not in the client-side context, or vice versa. Such context sharing allows for richer more complete metrics to be created which can better detail the end to end experience of clients, as well as bubble up various useful metadata from within the SDK itself.

The methods via which this context sharing is accomplished is described in the [API](#api) section.

## API

### submitClientMetrics

Submit Client Metrics is the basic interface with the metrics batcher. A client can supply a well formed metric, and the metric will subsequently be sent once a sufficiently large batch of metrics has accrued. If the metric is labeled as a "preLoginId" the metric will be sent immediately rather than being batched. Pre-login metrics occur during onboarding, so if we were to batch them, we may miss issues if new customers abort the onboarding process, as this will flush the batcher's store.

   * @param {string} eventName name of the metric
   * @param {Object} props properties to be sent as part of the metric
   * @param {string} preLoginId whether or not the metric is a preLoginMetric 
   * @returns {Object} HttpResponse object

### registerClientMetric

Register Client Metric is used by an external actor (the client of the SDK) to register, store, and label a metric as an external client metric. If a metric with the given "id" already exists in the store, the register method will return false. The client can then attempt secondary hashing, or take other actions as appropriate if this was an unexpected response.

  * @param {string} eventName name of the metric
  * @param {string} id unique identifier
  * @param {Object} props to populate the metric with
  * @returns {bool} true if metric registered, false otherwise

### registerMetric

Register Metric is used by the SDK internally to register, store, and label metrics as internal SDK metrics.  If a metric with the given "id" already exists in the store, the register method will return false.

  * @param {string} eventName name of the metric
  * @param {string} id unique identifier
  * @param {Object} props to populate the metric with
  * @returns {bool} true if metric registered, false otherwise

### updateRegisteredMetric

Updates fields of the metric stored under the identifier "id" if the metrics exists and the fields are present, or adds the fields if they do not exist. Returns false on failure, true otherwise.

   * @param {string} id lookup key for metric
   * @param {Object} metricProps to be used for updating metric
   * @returns {bool} true if the metrics exists and was updated, false otherwise

### sendClientRegisteredMetric

Sends the metrics stored under the identifer "id"; if it exists and is registered as a client metric; to the metrics batcher. Returns false if metric registered under "id" is an internal metric, or if it does not exist. After sending, the metric is removed from the store.

   * @param {string} id of the metric to be sent
   * @returns {Object} HttpResponse object

### sendRegisteredMetric

Sends the metrics stored under the identifer "id"; if it exists and is registered as an internal SDK metric; to the metrics batcher. Returns false if metric registered under "id" is an external client metric, or if it does not exist. After sending, the metric is removed from the store.

   * @param {string} id of the metric to be sent
   * @returns {Object} HttpResponse object

## Maintainers

[@ianwremmel](https://github.com/ianwremmel)

## Contribute

Pull requests welcome. Please see [CONTRIBUTING.md](./CONTRIBUTING.md) for more details about building the packages
and submitting pull requests for suggested changes.

## License

&copy; 2016-2017 Cisco Systems, Inc. and/or its affiliates. All Rights Reserved.

See [LICENSE](LICENSE) for details.
